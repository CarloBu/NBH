---
import { Image } from 'astro:assets';
import NeighbourhoodLogo from '../assets/neighbourhood-logo.svg';
import MarketingImg from '../assets/image-1.jpg';
import SalesImg from '../assets/image-2.jpg';
import WebsitesImg from '../assets/image-3.jpg';
import CustomerServiceImg from '../assets/image-4.jpg';
import PaidMediaImg from '../assets/image-5.jpg';
import HubspotImg from '../assets/image-6.jpg';
import OurStoryImg from '../assets/image-7.jpg';
import OurTeamImg from '../assets/image-8.jpg';
import LivinImg from '../assets/image-9.jpg';
import FeedDummyImg from '../assets/image-feed-dummy.jpg';

// Define the AnimatedNavLink component
const { currentPath } = Astro.props;
---

<!-- Fixed layout with logo on left and content on right -->
<div
	class="navbar-container fixed top-0 right-0 left-0 z-10 -translate-y-full transform bg-transparent transition-colors duration-200 will-change-transform"
>
	<div class="flex w-full p-[2vw]">
		<!-- Logo on the left -->
		<div class="mr-[4vw]">
			<div class="size-[16.5vw] cursor-pointer">
				<Image src={NeighbourhoodLogo} alt="Neighbourhood Logo" class="h-full w-full object-contain" />
			</div>
		</div>

		<!-- Right side content container -->
		<div class="flex w-full flex-col">
			<!-- at top -->
			<div class="w-full pt-[0.5vw]">
				<div class="flex items-center justify-end">
					<div class="mr-[11vw] flex items-center">
						<div class="nav-item-container px-[1.5vw]">
							<a href="#work" class="animated-nav-link relative text-[1.25vw] font-semibold text-black">
								Work
								<span class="underline-animation absolute bottom-0 left-0 h-[3px] w-0 bg-black"></span>
							</a>
						</div>
						<div class="nav-item-container px-[1.5vw]">
							<a
								href="#about"
								class="animated-nav-link dropdown-trigger relative text-[1.25vw] font-semibold text-black"
								data-dropdown="about-dropdown"
							>
								About
								<span class="underline-animation absolute bottom-0 left-0 h-[3px] w-0 bg-black"></span>
							</a>
						</div>
						<div class="nav-item-container px-[1.5vw]">
							<a
								href="#services"
								class="animated-nav-link dropdown-trigger relative text-[1.25vw] font-semibold text-black"
								data-dropdown="services-dropdown"
							>
								Services
								<span class="underline-animation absolute bottom-0 left-0 h-[3px] w-0 bg-black"></span>
							</a>
						</div>
						<div class="nav-item-container px-[1.5vw]">
							<a
								href="#feed"
								class="animated-nav-link dropdown-trigger relative text-[1.25vw] font-semibold text-black"
								data-dropdown="feed-dropdown"
							>
								Feed
								<span class="underline-animation absolute bottom-0 left-0 h-[3px] w-0 bg-black"></span>
							</a>
						</div>
						<div class="nav-item-container px-[1.5vw]">
							<a href="#pricing" class="animated-nav-link relative text-[1.25vw] font-semibold text-black">
								Pricing
								<span class="underline-animation absolute bottom-0 left-0 h-[3px] w-0 bg-black"></span>
							</a>
						</div>
					</div>
					<a
						href="#contact"
						class="contact-button absolute flex h-[4.5vw] w-[9vw] items-center justify-center rounded-[3.4vw] bg-white px-[1.5vw] text-[1.25vw] font-semibold text-black transition-colors duration-200"
						>Contact</a
					>
				</div>
			</div>

			<!-- Dropdown containers -->
			<div class="dropdown-containers w-full">
				<!-- Services dropdown -->
				<div id="services-dropdown" class="dropdown-content hidden w-full">
					<div class="">
						<div class="">
							<h2 class="-mt-[0.5vw] mb-[1vw] text-[1.25vw] font-semibold">Services</h2>
						</div>

						<div class="grid grid-cols-6 gap-[0.75vw]">
							<!-- Marketing Growth -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={MarketingImg} alt="Marketing Growth" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Marketing<br />Growth</h3>
							</div>

							<!-- Sales CRM -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={SalesImg} alt="Sales CRM" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Sales<br />CRM</h3>
							</div>

							<!-- Websites Integrations -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={WebsitesImg} alt="Websites Integrations" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Websites<br />Integrations</h3>
							</div>

							<!-- Customer Service -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={CustomerServiceImg} alt="Customer Service" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Customer Service<br />Ticketing</h3>
							</div>

							<!-- Paid Media -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={PaidMediaImg} alt="Paid Media" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Paid Media<br />SEO</h3>
							</div>

							<!-- HubSpot -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw] bg-red-500">
									<Image src={HubspotImg} alt="HubSpot Onboarding" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">HubSpot Onboarding<br />Support</h3>
							</div>
						</div>
					</div>
				</div>

				<!-- About dropdown - using same layout structure -->
				<div id="about-dropdown" class="dropdown-content hidden w-full">
					<div class="">
						<div class="">
							<h2 class="-mt-[0.5vw] mb-[1vw] text-[1.25vw] font-semibold">About</h2>
						</div>

						<div class="grid grid-cols-6 gap-[0.75vw]">
							<!-- Our Story -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={OurStoryImg} alt="Our Story" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Our Story</h3>
							</div>

							<!-- Our Team -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={OurTeamImg} alt="Our Team" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Our Team</h3>
							</div>

							<!-- Livin -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={LivinImg} alt="Livin" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Livin</h3>
							</div>
						</div>
					</div>
				</div>

				<!-- Feed dropdown - using same layout structure -->
				<div id="feed-dropdown" class="dropdown-content hidden w-full">
					<div class="">
						<div class="">
							<h2 class="-mt-[0.5vw] mb-[1vw] text-[1.25vw] font-semibold">Feed</h2>
						</div>

						<div class="grid grid-cols-6 gap-[0.75vw]">
							<!-- Featured Post 1 -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={FeedDummyImg} alt="Featured Post 1" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Featured Post 1</h3>
							</div>

							<!-- Featured Post 2 -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={FeedDummyImg} alt="Featured Post 2" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Featured Post 2</h3>
							</div>

							<!-- Featured Post 3 -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={FeedDummyImg} alt="Featured Post 3" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Featured Post 3</h3>
							</div>

							<!-- Featured Post 4 -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={FeedDummyImg} alt="Featured Post 4" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Featured Post 4</h3>
							</div>

							<!-- Featured Post 5 -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={FeedDummyImg} alt="Featured Post 5" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Featured Post 5</h3>
							</div>

							<!-- Featured Post 6 -->
							<div class="flex cursor-pointer flex-col">
								<div class="relative mb-[0.5vw] aspect-square w-full overflow-hidden rounded-[1vw]">
									<Image src={FeedDummyImg} alt="Featured Post 6" class="absolute inset-0 z-20 h-full w-full object-cover" />
								</div>
								<h3 class="text-[1.15vw] font-semibold text-black">Featured Post 6</h3>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	import { gsap } from 'gsap';

	// Track active dropdowns and their states
	const activeDropdowns = new Map();

	// Helper function to safely get relatedTarget
	const getRelatedTarget = (e: Event): Node | null => {
		return (e as MouseEvent).relatedTarget as Node | null;
	};

	// Helper function to animate the underline
	const animateUnderline = (underline: Element, show: boolean) => {
		if (show) {
			// Check if already shown to avoid re-animation
			if (underline.getAttribute('data-animated') === 'true') return;

			gsap.fromTo(underline, { width: 0, left: 0, right: 'auto' }, { width: '100%', duration: 0.3, ease: 'power2.out', overwrite: true });
			underline.setAttribute('data-animated', 'true');
		} else {
			// Reset animation state
			underline.setAttribute('data-animated', 'false');
			gsap.to(underline, {
				width: 0,
				right: 0,
				left: 'auto',
				duration: 0.3,
				ease: 'power1.inOut',
				overwrite: true,
			});
		}
	};

	// Function to animate the navbar entry
	const animateNavbarEntry = () => {
		const navbar = document.querySelector('.navbar-container');

		if (navbar) {
			gsap.to(navbar, {
				y: 0,
				duration: 0.65,
				ease: 'cubic-bezier(0.19, 1, 0.22, 1)',
				onComplete: () => {
					navbar.classList.add('is-active');
				},
			});
		}
	};

	// Function to initialize the animated nav links
	const initAnimatedNavLinks = () => {
		// Only target links with the specific animated-nav-link class
		const links = document.querySelectorAll('.animated-nav-link');
		const containers = document.querySelectorAll('.nav-item-container');
		const navbarContainer = document.querySelector('.navbar-container');

		containers.forEach((container) => {
			const link = container.querySelector('.animated-nav-link');
			const underline = link ? link.querySelector('.underline-animation') : null;

			// Only add listeners if both link and underline exist
			if (link && underline) {
				container.addEventListener('mouseenter', () => {
					animateUnderline(underline, true);
				});

				container.addEventListener('mouseleave', (e) => {
					// Check if we're moving to the dropdown
					const dropdownId = link.getAttribute('data-dropdown');
					if (!dropdownId) {
						// No dropdown, just hide the underline
						animateUnderline(underline, false);
						return;
					}

					const dropdown = document.getElementById(dropdownId);
					if (!dropdown) {
						animateUnderline(underline, false);
						return;
					}

					// Check if we're moving to the dropdown using relatedTarget
					const relatedTarget = getRelatedTarget(e);
					if (relatedTarget && (dropdown.contains(relatedTarget) || relatedTarget === dropdown)) {
						// Moving to the dropdown - don't hide the underline
						return;
					}

					// Use a timeout to check if we're still not hovering the dropdown
					setTimeout(() => {
						const isOverDropdown = dropdown.matches(':hover');
						const isOverContainer = container.matches(':hover');

						if (!isOverDropdown && !isOverContainer) {
							animateUnderline(underline, false);
						}
					}, 100);
				});
			}
		});
	};

	// Function to initialize dropdown behavior
	const initDropdowns = () => {
		const dropdownTriggers = document.querySelectorAll('.dropdown-trigger');
		const dropdownContents = document.querySelectorAll('.dropdown-content');
		const navItemContainers = document.querySelectorAll('.nav-item-container');
		const navbarContainer = document.querySelector('.navbar-container');
		const contactButton = document.querySelector('.contact-button');

		// Hide all dropdowns by default
		dropdownContents.forEach((content) => {
			content.classList.add('hidden');
		});

		// Add hover events to dropdown triggers and their containers
		dropdownTriggers.forEach((trigger) => {
			const dropdownId = trigger.getAttribute('data-dropdown');
			if (!dropdownId) return;

			const dropdown = document.getElementById(dropdownId);
			if (!dropdown) return;

			const underline = trigger.querySelector('.underline-animation');

			// Get the parent container of this trigger
			const container = trigger.closest('.nav-item-container');
			if (!container) return;

			// Set initial animation state
			if (underline) {
				underline.setAttribute('data-animated', 'false');
			}

			// Show dropdown on mouseenter (for both container and trigger)
			const showDropdown = () => {
				// Add is-dd class to navbar
				if (navbarContainer) {
					navbarContainer.classList.add('is-dd');
				}

				// Hide all dropdowns first
				dropdownContents.forEach((content) => {
					// Hide other dropdowns
					if (content.id !== dropdownId) {
						content.classList.add('hidden');
					}
				});

				// Show this dropdown
				dropdown.classList.remove('hidden');

				// Add white background to entire navbar
				if (navbarContainer) {
					navbarContainer.classList.add('bg-white');

					// Switch contact button to black for contrast
					if (contactButton) {
						contactButton.classList.remove('bg-white', 'text-black');
						contactButton.classList.add('bg-black', 'text-white');
					}
				}

				// Make sure underline is visible
				if (underline) {
					animateUnderline(underline, true);
				}

				// Animate dropdown elements
				const dropdownItems = dropdown.querySelectorAll('.flex.cursor-pointer');
				gsap.fromTo(
					dropdownItems,
					{ opacity: 0, y: 20 },
					{
						opacity: 1,
						y: 0,
						duration: 0.5,
						stagger: 0.05,
						ease: 'power3.out',
					},
				);
			};

			container.addEventListener('mouseenter', showDropdown);

			// Hide dropdown when mouse leaves navbar - add null check
			if (navbarContainer) {
				navbarContainer.addEventListener('mouseleave', () => {
					dropdown.classList.add('hidden');

					// Remove is-dd class from navbar
					navbarContainer.classList.remove('is-dd');

					// Remove white background from navbar
					navbarContainer.classList.remove('bg-white');

					// Reset contact button to white
					if (contactButton) {
						contactButton.classList.remove('bg-black', 'text-white');
						contactButton.classList.add('bg-white', 'text-black');
					}

					// Hide underline when leaving entire navbar
					if (underline) {
						animateUnderline(underline, false);
					}
				});
			}

			// Hide dropdown when mouse leaves the container
			container.addEventListener('mouseleave', (e) => {
				// Check if we're moving to the dropdown using relatedTarget
				const relatedTarget = getRelatedTarget(e);
				if (relatedTarget && (dropdown.contains(relatedTarget) || relatedTarget === dropdown)) {
					// Moving to the dropdown - don't hide anything
					return;
				}

				// Use setTimeout to allow checking if mouse moved to dropdown
				setTimeout(() => {
					const isOverDropdown = dropdown.matches(':hover');
					const isOverContainer = container.matches(':hover');

					if (!isOverDropdown && !isOverContainer) {
						dropdown.classList.add('hidden');

						// Remove is-dd class if all dropdowns are closed
						if (navbarContainer && !anyDropdownVisible()) {
							navbarContainer.classList.remove('is-dd');
						}

						// Remove white background if all dropdowns are closed
						if (navbarContainer && !anyDropdownVisible()) {
							navbarContainer.classList.remove('bg-white');

							// Reset contact button to white
							if (contactButton) {
								contactButton.classList.remove('bg-black', 'text-white');
								contactButton.classList.add('bg-white', 'text-black');
							}
						}

						// Hide underline only if not hovering dropdown
						if (!isOverDropdown && underline) {
							animateUnderline(underline, false);
						}
					}
				}, 100);
			});
		});

		// Keep dropdown visible when hovering over it
		dropdownContents.forEach((content) => {
			content.addEventListener('mouseenter', (e) => {
				content.classList.remove('hidden');

				// Make sure navbar background is white
				if (navbarContainer) {
					navbarContainer.classList.add('bg-white');
					navbarContainer.classList.add('is-dd');

					// Switch contact button to black for contrast
					if (contactButton) {
						contactButton.classList.remove('bg-white', 'text-black');
						contactButton.classList.add('bg-black', 'text-white');
					}
				}

				// Keep the parent link's underline visible
				const contentId = content.id;
				const relatedTrigger = document.querySelector(`.dropdown-trigger[data-dropdown="${contentId}"]`);
				const underline = relatedTrigger ? relatedTrigger.querySelector('.underline-animation') : null;

				if (underline) {
					animateUnderline(underline, true);
				}
			});

			content.addEventListener('mouseleave', (e) => {
				// Check if the mouse moved back to the trigger's container
				const contentId = content.id;
				const relatedTrigger = document.querySelector(`.dropdown-trigger[data-dropdown="${contentId}"]`);
				const relatedContainer = relatedTrigger ? relatedTrigger.closest('.nav-item-container') : null;
				const underline = relatedTrigger ? relatedTrigger.querySelector('.underline-animation') : null;

				// Check if we're moving to the container using relatedTarget
				const relatedTarget = getRelatedTarget(e);
				if (relatedTarget && relatedContainer && (relatedContainer.contains(relatedTarget) || relatedTarget === relatedContainer)) {
					// Moving to the container - don't hide anything
					return;
				}

				// Use setTimeout to allow checking if mouse moved to container
				setTimeout(() => {
					const isOverRelatedContainer = relatedContainer && relatedContainer.matches(':hover');

					if (!isOverRelatedContainer) {
						content.classList.add('hidden');

						// Remove is-dd class if all dropdowns are closed
						if (navbarContainer && !anyDropdownVisible()) {
							navbarContainer.classList.remove('is-dd');
						}

						// Remove white background if all dropdowns are closed
						if (navbarContainer && !anyDropdownVisible()) {
							navbarContainer.classList.remove('bg-white');

							// Reset contact button to white
							if (contactButton) {
								contactButton.classList.remove('bg-black', 'text-white');
								contactButton.classList.add('bg-white', 'text-black');
							}
						}

						// Hide the underline if not hovering the related container
						if (underline) {
							animateUnderline(underline, false);
						}
					}
				}, 100);
			});
		});

		// Helper function to check if any dropdown is visible
		function anyDropdownVisible() {
			let visible = false;
			dropdownContents.forEach((content) => {
				if (!content.classList.contains('hidden')) {
					visible = true;
				}
			});
			return visible;
		}
	};

	// Initialize animations when the DOM is loaded
	document.addEventListener('DOMContentLoaded', () => {
		// Animate the navbar entry
		animateNavbarEntry();

		initAnimatedNavLinks();
		initDropdowns();
	});

	// Also reinitialize when the document becomes visible (for view transitions)
	document.addEventListener('astro:page-load', () => {
		// Animate the navbar entry
		animateNavbarEntry();

		initAnimatedNavLinks();
		initDropdowns();
	});
</script>

<style>
	.nav-item-container {
		cursor: pointer;
		display: flex;
		align-items: center;
	}

	.navbar-container {
		transition: transform 0.65s cubic-bezier(0.19, 1, 0.22, 1);
	}

	.navbar-container.is-active {
		transform: translateY(0);
	}

	.dropdown-content {
		transition: opacity 0.35s ease-out;
	}

	.navbar-line {
		will-change: transform;
	}
</style>
